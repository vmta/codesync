#!/usr/bin/env bash


# Stage 1 - get diff file

DIR=$( pwd );

CLONE="umkoin";
MAINSTREAM="bitcoin";

#DIFFFILE="$( pwd )/git.diffs";
DIFFFILE="$DIR/git.diffs";
#DIFFTMP="$( pwd )/diff.tmp";
DIFFTMP="$DIR/diff.tmp";
FILES=();
#SUBST="$( pwd )/common/substitutes";
SUBST="$DIR/common/substitutes";

pushd $DIR/$CLONE;
git pull origin master;
for SYNCED_COMMIT in $( git log --format='%s' | grep "Sync to mainstream commit" | awk '{ print $5 }' ); do
    break;
done
popd;


pushd $DIR/$MAINSTREAM;
git pull origin master;
# -=or=-
# git fetch;
# git merge;

git diff $SYNCED_COMMIT HEAD | sed -f $SUBST > $DIFFFILE; # auto apply substitions

## set stage 1.1 = get per-file-diffs with auto substitution
for FILE in $( git diff --name-only $SYNCED_COMMIT HEAD ); do
    FILES+=( $( echo $FILE | sed 's/bitcoin/umkoin/g' ) );

    [ ! -d $DIFFTMP ] && mkdir $DIFFTMP;
##    DEST="$DIFFTMP/$( echo ${FILE##*/} )";
    DEST="$DIFFTMP/$( echo ${FILES[-1]##*/} )";
echo $DEST;
#
    if [ ! -f "$DIR/$CLONE/${FILES[-1]}" ]; then
        [ ! -d "$( dirname $DIR/$CLONE/${FILES[-1]} )" ] && mkdir "$( dirname $DIR/$CLONE/${FILES[-1]} )";
        touch $DIR/$CLONE/$FILES[-1];
    fi

#    git diff "../umkoin/$FILE" $FILE | sed -f $SUBST > $DEST;
###    git diff "$DIR/$CLONE/$FILE" $FILE | sed -f $SUBST > $DEST;
echo "$DIR/$CLONE/${FILES[-1]}";
#    git diff "../umkoin/$FILE" $FILE > $DEST;

done;
popd;


printf "Diff file:\t%s\n" $DIFFFILE;
printf "Files to patch:\t%d\n" ${#FILES[@]};
#printf "              :\t%s\n" ${FILES[@]};



exit $?
